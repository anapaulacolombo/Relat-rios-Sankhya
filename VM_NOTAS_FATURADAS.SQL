--ALTER SESSION SET CURRENT_SCHEMA=sankhya;

CREATE MATERIALIZED VIEW VM_NOTAS_FATURADAS
BUILD IMMEDIATE
REFRESH ON DEMAND AS

select "DTENTSAI","DTNEG","DTFATUR","EMPRESA","RAZAOSOCIAL","CID_ORIGEM","UF_ORIGEM","NUNOTA","NOTA_FISCAL","PEDIDO","AD_NUINVOICE",
       "PARCEIRO","NOMEPARC","CODPARCMATRIZ","NOMEPARCMATRIZ","CODNAT","DESCRNAT","CODCTACTB","DESCRCTA","COD_VENDEDOR","VENDEDOR",
       "TOP","DESC_TOP","SEQUENCIA","CODPROD","DESCRPROD","EAN","ALIQICMS","BASEICMS","VLRICMS","ALIQIPI","VLRIPI","BASEIPI",
       "BASESUBSTIT","VLRSUBST","CODCFO","QTDNEG","NCM","VLRUNIT","VLR_NF","VALOR_ITEM","VALOR_ITEM_IMPOSTOS","VLRMOEDA","VLRISS",
       "VLRDESC","CODGRUPOPROD","DESCRGRUPOPROD","MARCA","NOMEREG","GRUPO","TIPMOV","MES_ANO","VLRTOTITE","VLRDESCTOT","VLRDESCTOTITEM",
       "VLRDESCTOTITEMMOE","DESCRCENCUS","ICMS","ST","IPI","ISS","PIS","COFINS","FGCOLOR","TIPODESCONTO","NOMECID","DESCRICAO","UF",
       "NETPRICE","CODTIPPARC","DESCRTIPPARC","VLRDIFALDEST","VLRFCP","BASEDIFAL","BASEFCP","IDALIQICMS","MARGLUCRO","ALIQSUBTRIB",
       "PERCSTFCPINT","CGC_CPF","TIPPESSOA","GERENTE","CTACONCIL","CODCENCUS","CODAGRUPPROD","DESCRAGRUPPROD","TABPRECO","ROYALTIES_TAXA",
       "VLRFRETE",--"SEQITE",
       "TIPFRETE","DTPEDIDO","NOMEFANTASIA","DTALTER","CODTIPVENDA","DESCRTIPVENDA","NUNOTA_PED","AD_NUNOTA",
       "AD_NUNOTAORIG"
from(
SELECT distinct
       CAB.DTENTSAI,
       CAB.DTNEG AS DTNEG,
       CAB.DTFATUR AS DTFATUR,
       CAB.CODEMP AS EMPRESA,
       EMP.RAZAOSOCIAL,
       CIDEMP.NOMECID CID_ORIGEM,
       UFSEMP.UF  UF_ORIGEM,
       CAB.NUNOTA,
       CAB.NUMNOTA || '/' || CAB.SERIENOTA AS NOTA_FISCAL,
       VAR.NUNOTAORIG AS PEDIDO,
       CAB.AD_NUINVOICE,
       CAB.CODPARC AS PARCEIRO,
       PAR.NOMEPARC,
       PAR.CODPARCMATRIZ,
       MAT.NOMEPARC NOMEPARCMATRIZ,
       CAB.CODNAT,
       NAT.DESCRNAT,
       NAT.CODCTACTB,
       PLA.DESCRCTA,
       CAB.CODVEND AS COD_VENDEDOR,
       VEN.APELIDO AS VENDEDOR,
       CAB.CODTIPOPER AS TOP,
       TOP.DESCROPER AS DESC_TOP,
       ITE.SEQUENCIA,
       ITE.CODPROD CODPROD,
       PROD.DESCRPROD DESCRPROD,
       VOA.CODBARRA AS EAN,
       ITE.ALIQICMS,
       DIN.BASEICMS,
       DIN.VLRICMS,
       ITE.ALIQIPI,
       ITE.VLRIPI,
       ITE.BASEIPI,
       ITE.BASESUBSTIT,
       ITE.VLRSUBST,
       ITE.CODCFO,
       ITE.QTDNEG,
       PROD.NCM,
       COALESCE(ITE.VLRUNIT,ITE.Vlrunitmoe) VLRUNIT,
       CAB.VLRNOTA VLR_NF,
       ( ITE.VLRTOT - ITE.VLRDESC ) AS VALOR_ITEM,
       (ITE.Vlrtot + ITE.VLRIPI + ITE.VLRSUBST) - ITE.VLRDESC VALOR_ITEM_IMPOSTOS,
       CAB.VLRMOEDA,
       ITE.VLRISS,
       ITE.VLRDESC,
       PROD.CODGRUPOPROD,
       GRU.DESCRGRUPOPROD,
       PROD.MARCA,
       REG.NOMEREG,
       TOP.GRUPO,
       TOP.TIPMOV,
       TO_CHAR(CAB.DTENTSAI, 'mm/yyyy') MES_ANO,
       ITE.Vlrtot VLRTOTITE,
       CAB.VLRDESCTOT, CAB.VLRDESCTOTITEM, CAB.VLRDESCTOTITEMMOE,
       CUS.DESCRCENCUS,
       IMP.ICMS,
       IMP.ST,
       IMP.IPI,
       IMP.ISS,
       IMP.PIS,
       IMP.COFINS,
      CASE WHEN (CAB.VLRDESCTOT+ CAB.VLRDESCTOTITEM +CAB.VLRDESCTOTITEMMOE) > 1 THEN '#FF0000'
      ELSE '' END AS FGCOLOR,
      CASE WHEN ITE.AD_TIPODESCONTO = 'P' THEN 'Duzia de 13'
           WHEN ITE.AD_TIPODESCONTO = 'B' THEN 'Bonificacao'
           WHEN ITE.AD_TIPODESCONTO = 'V' THEN 'Verba Vip'
           WHEN ITE.AD_TIPODESCONTO = 'D' THEN 'Desconto Perfumaria'
           WHEN ITE.AD_TIPODESCONTO = 'N' THEN 'Sem Desconto' end TipoDesconto,
      CID.NOMECID,
      UFS.DESCRICAO,
      UFS.UF,
      ite.vlrcus * ite.qtdneg NetPrice,
        PAR.CODTIPPARC,
        TPP.DESCRTIPPARC,
        DIN.VLRDIFALDEST,
        DIN.VLRFCP,
        DIN.BASEDIFAL,
        DIN.BASEFCP,
        ITE.IDALIQICMS,
        ICM.MARGLUCRO,
        ICM.ALIQSUBTRIB,
        ICM.PERCSTFCPINT,
        PAR.CGC_CPF,
        PAR.TIPPESSOA,
        GER.APELIDO GERENTE,
        CASE WHEN CAB.CODNAT BETWEEN 1010000 AND 1029999 AND NVL(NAT.CODCTACTB,NAT.CODCTACTB2) in (196,217,274,295,301,1929,4395) then PLA.AD_CODCTACTB
             WHEN CAB.CODNAT BETWEEN 1010000 AND 1029999 AND NVL(NAT.CODCTACTB,NAT.CODCTACTB2) = 711 then 219
             WHEN CAB.CODNAT BETWEEN 1010000 AND 1029999 AND NVL(NAT.CODCTACTB,NAT.CODCTACTB2) = 2953 then 198
             WHEN CAB.CODNAT BETWEEN 1010000 AND 1029999 AND NVL(NAT.CODCTACTB,NAT.CODCTACTB2) = 1766 then 217
             WHEN CAB.CODNAT BETWEEN 2010000 AND 2099999 AND NVL(NAT.CODCTACTB,NAT.CODCTACTB2) in (295,301) then 296
             WHEN CAB.CODNAT BETWEEN 2010000 AND 2099999 AND NVL(NAT.CODCTACTB,NAT.CODCTACTB2) in (711,274,1766,2953,1929,4395,196,217,763) then 274
             WHEN CAB.CODTIPOPER IN (3218,3246,3219) THEN 274
             WHEN CAB.CODTIPOPER IN (3231) THEN 296
             WHEN CAB.CODTIPOPER IN (2215) THEN 297
             else PLA.AD_CODCTACTB end CTACONCIL,
        CAB.CODCENCUS,
        AGRUP.CODAGRUPPROD,
        AGRUP.DESCRAGRUPPROD,
        case when exists(select 1 from tgftab where nutab = ITE.NUTAB) then (select n.codtab || ' - ' ||  n.nometab from tgftab t, tgfnta n where t.codtab = n.codtab and  t.nutab =  ITE.NUTAB) end TABPRECO,
        case when prod.codgrupoprod in (990201000) then 0 else round(ITE.Vlrtot * PAR.AD_PERCSERVICOS,2) end Royalties_Taxa,
        case when cab.TIPFRETE = 'N' THEN 0 ELSE  CAB.VLRFRETE END VLRFRETE,
       -- (select max(sequencia) Seq from tgfite where nunota = cab.nunota)  SEQITE,
        cab.tipfrete,
        CAB_PED.DTNEG DTPEDIDO,
        EMP.NOMEFANTASIA,
        CAB.DTALTER,
        cab.codtipvenda,
        TPV.DESCRTIPVENDA,
        CAB_PED.NUNOTA NUNOTA_PED,
        CAB_PED.AD_NUNOTA AD_NUNOTA,
        CAB_PED.AD_NUNOTAORIG
FROM TGFCAB CAB
 INNER JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA AND CAB.CODEMP = ITE.CODEMP
 INNER JOIN TGFPAR PAR ON (PAR.CODPARC = CAB.CODPARC)
 LEFT  JOIN TGFPAR MAT ON (MAT.CODPARC  = PAR.CODPARCMATRIZ)
 LEFT  JOIN TSIREG REG ON PAR.CODREG = REG.CODREG
 LEFT  JOIN TGFVEN VEN ON (VEN.CODVEND = CAB.CODVEND)
 LEFT  JOIN TGFVAR VAR ON (VAR.NUNOTA = ITE.NUNOTA AND VAR.SEQUENCIA = ITE.SEQUENCIA)
 LEFT  JOIN TGFNAT NAT ON NAT.CODNAT = CAB.CODNAT
 LEFT  JOIN TCBPLA PLA ON PLA.CODCTACTB = NAT.CODCTACTB
 LEFT  JOIN TSICUS CUS ON CUS.CODCENCUS = CAB.CODCENCUS
 INNER JOIN TGFTOP TOP ON CAB.CODTIPOPER = TOP.CODTIPOPER AND CAB.DHTIPOPER = TOP.DHALTER
 INNER JOIN TGFPRO PROD ON ITE.CODPROD = PROD.CODPROD
 LEFT  JOIN TGFGRU GRU ON PROD.CODGRUPOPROD = GRU.CODGRUPOPROD
 LEFT  JOIN TGFICM ICM ON ICM.IDALIQ = ITE.IDALIQICMS
 LEFT  JOIN TGFVOA VOA ON PROD.CODPROD = VOA.CODPROD AND VOA.CODVOL = ITE.Codvol
 LEFT  JOIN (SELECT SUM(BASERED) BASEICMS, SUM(VALOR) VLRICMS,
            SUM(VLRDIFALDEST) VLRDIFALDEST, SUM(VLRFCP) VLRFCP,
            SUM(BASEDIFAL) BASEDIFAL, SUM(BASEFCP) BASEFCP,
            CODIMP, SEQUENCIA, NUNOTA
            FROM TGFDIN
            GROUP BY CODIMP, SEQUENCIA, NUNOTA) DIN ON CAB.NUNOTA = DIN.NUNOTA AND DIN.SEQUENCIA = ITE.SEQUENCIA AND DIN.CODIMP = 1
 LEFT JOIN OutrosImpostosPV IMP on ite.nunota = IMP.nunota and ite.sequencia = imp.sequencia
 LEFT JOIN TSICID CID ON  PAR.CODCID = CID.CODCID
 LEFT JOIN TSIUFS UFS ON  CID.UF = UFS.CODUF
 LEFT JOIN TGFTPP TPP ON PAR.CODTIPPARC = TPP.CODTIPPARC
 LEFT JOIN TGFVEN GER ON (VEN.Codger = GER.CODVEND)
 LEFT JOIN AD_AGRUPPROD AGRUP ON PROD.AD_CODAGRUPPROD = AGRUP.CODAGRUPPROD
 LEFT JOIN TSIEMP EMP ON EMP.CODEMP = CAB.CODEMP
 LEFT JOIN TSICID CIDEMP ON  CIDEMP.CODCID = EMP.CODCID
 LEFT JOIN TSIUFS UFSEMP ON  CIDEMP.UF = UFSEMP.CODUF
 LEFT JOIN TGFCAB CAB_PED ON CAB_PED.NUNOTA = VAR.NUNOTAORIG
 LEFT JOIN TGFTPV TPV ON CAB.CODTIPVENDA = TPV.CODTIPVENDA

 WHERE CAB.STATUSNOTA = 'L'
   AND (CAB.statusnfe = 'A' or CAB.statusnfse = 'A')
   AND TOP.TIPMOV = 'V'
   AND TOP.GRUPO <> 'Complementar'


UNION ALL

SELECT distinct
       CAB.DTENTSAI,
       CAB.DTNEG AS DTNEG,
       CAB.DTFATUR AS DTFATUR,
       CAB.CODEMP AS EMPRESA,
       EMP.RAZAOSOCIAL,
       CIDEMP.NOMECID CID_ORIGEM,
       UFSEMP.UF  UF_ORIGEM,
       CAB.NUNOTA,
       CAB.NUMNOTA || '/' || CAB.SERIENOTA AS NOTA_FISCAL,
       VAR.NUNOTAORIG AS PEDIDO,
       CAB.AD_NUINVOICE,
       CAB.CODPARC AS PARCEIRO,
       PAR.NOMEPARC,
       PAR.CODPARCMATRIZ,
       MAT.NOMEPARC NOMEPARCMATRIZ,
       CAB.CODNAT,
       NAT.DESCRNAT,
       NAT.CODCTACTB,
       PLA.DESCRCTA,
       CAB.CODVEND AS COD_VENDEDOR,
       VEN.APELIDO AS VENDEDOR,
       CAB.CODTIPOPER AS TOP,
       TOP.DESCROPER AS DESC_TOP,
       ITE.SEQUENCIA,
       ITE.CODPROD CODPROD,
       PROD.DESCRPROD DESCRPROD,
       VOA.CODBARRA AS EAN,
       ITE.ALIQICMS,
       DIN.BASEICMS,
       DIN.VLRICMS,
       ITE.ALIQIPI,
       ITE.VLRIPI,
       ITE.BASEIPI,
       ITE.BASESUBSTIT,
       ITE.VLRSUBST,
       ITE.CODCFO,
       ITE.QTDNEG,
       PROD.NCM,
       COALESCE(ITE.VLRUNIT,ITE.Vlrunitmoe) VLRUNIT,
       CAB.VLRNOTA VLR_NF,
       ( ITE.VLRTOT - ITE.VLRDESC ) AS VALOR_ITEM,
       (ITE.Vlrtot + ITE.VLRIPI + ITE.VLRSUBST) - ITE.VLRDESC VALOR_ITEM_IMPOSTOS,
       CAB.VLRMOEDA,
       ITE.VLRISS,
       ITE.VLRDESC,
       PROD.CODGRUPOPROD,
       GRU.DESCRGRUPOPROD,
       PROD.MARCA,
       REG.NOMEREG,
       TOP.GRUPO,
       TOP.TIPMOV,
       TO_CHAR(CAB.DTENTSAI, 'mm/yyyy') MES_ANO,
       ITE.Vlrtot VLRTOTITE,
       CAB.VLRDESCTOT, CAB.VLRDESCTOTITEM, CAB.VLRDESCTOTITEMMOE,
       CUS.DESCRCENCUS,
       IMP.ICMS,
       IMP.ST,
       IMP.IPI,
       IMP.ISS,
       IMP.PIS,
       IMP.COFINS,
      CASE WHEN (CAB.VLRDESCTOT+ CAB.VLRDESCTOTITEM +CAB.VLRDESCTOTITEMMOE) > 1 THEN '#FF0000'
      ELSE '' END AS FGCOLOR,
      CASE WHEN ITE.AD_TIPODESCONTO = 'P' THEN 'Duzia de 13'
           WHEN ITE.AD_TIPODESCONTO = 'B' THEN 'Bonificacao'
           WHEN ITE.AD_TIPODESCONTO = 'V' THEN 'Verba Vip'
           WHEN ITE.AD_TIPODESCONTO = 'D' THEN 'Desconto Perfumaria'
           WHEN ITE.AD_TIPODESCONTO = 'N' THEN 'Sem Desconto' end TipoDesconto,
      CID.NOMECID,
      UFS.DESCRICAO,
      UFS.UF,
      ite.vlrcus * ite.qtdneg NetPrice,
        PAR.CODTIPPARC,
        TPP.DESCRTIPPARC,
        DIN.VLRDIFALDEST,
        DIN.VLRFCP,
        DIN.BASEDIFAL,
        DIN.BASEFCP,
        ITE.IDALIQICMS,
        ICM.MARGLUCRO,
        ICM.ALIQSUBTRIB,
        ICM.PERCSTFCPINT,
        PAR.CGC_CPF,
        PAR.TIPPESSOA,
        GER.APELIDO GERENTE,
        CASE WHEN CAB.CODNAT BETWEEN 1010000 AND 1029999 AND NVL(NAT.CODCTACTB,NAT.CODCTACTB2) in (196,217,274,295,301,1929,4395) then PLA.AD_CODCTACTB
             WHEN CAB.CODNAT BETWEEN 1010000 AND 1029999 AND NVL(NAT.CODCTACTB,NAT.CODCTACTB2) = 711 then 219
             WHEN CAB.CODNAT BETWEEN 1010000 AND 1029999 AND NVL(NAT.CODCTACTB,NAT.CODCTACTB2) = 2953 then 198
             WHEN CAB.CODNAT BETWEEN 1010000 AND 1029999 AND NVL(NAT.CODCTACTB,NAT.CODCTACTB2) = 1766 then 217
             WHEN CAB.CODNAT BETWEEN 2010000 AND 2099999 AND NVL(NAT.CODCTACTB,NAT.CODCTACTB2) in (295,301) then 296
             WHEN CAB.CODNAT BETWEEN 2010000 AND 2099999 AND NVL(NAT.CODCTACTB,NAT.CODCTACTB2) in (711,274,1766,2953,1929,4395,196,217,763) then 274
             WHEN CAB.CODTIPOPER IN (3218,3246,3219) THEN 274
             WHEN CAB.CODTIPOPER IN (3231) THEN 296
             WHEN CAB.CODTIPOPER IN (2215) THEN 297
             else PLA.AD_CODCTACTB end CTACONCIL,
        CAB.CODCENCUS,
        AGRUP.CODAGRUPPROD,
        AGRUP.DESCRAGRUPPROD,
        case when exists(select 1 from tgftab where nutab = ITE.NUTAB) then (select n.codtab || ' - ' ||  n.nometab from tgftab t, tgfnta n where t.codtab = n.codtab and  t.nutab =  ITE.NUTAB) end  TABPRECO,
        case when prod.codgrupoprod in (990201000) then 0 else round(ITE.Vlrtot *   PAR.AD_PERCSERVICOS,2)  end Royalties_Taxa,
        case when CAB.TIPFRETE = 'N' THEN 0 ELSE  CAB.VLRFRETE END VLRFRETE,
      --  (select max(sequencia) Seq from tgfite where nunota = cab.nunota) SEQITE,
        cab.tipfrete,
        CAB_PED.DTNEG DTPEDIDO,
        EMP.NOMEFANTASIA,
        CAB.DTALTER,
        cab.codtipvenda,
        TPV.DESCRTIPVENDA,
        CAB_PED.NUNOTA NUNOTA_PED,
        CAB_PED.AD_NUNOTA AD_NUNOTA,
        CAB_PED.AD_NUNOTAORIG
FROM TGFCAB CAB
 INNER JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA AND CAB.CODEMP = ITE.CODEMP
 INNER JOIN TGFPAR PAR ON (PAR.CODPARC = CAB.CODPARC)
 LEFT  JOIN TGFPAR MAT ON (MAT.CODPARC  = PAR.CODPARCMATRIZ)
 LEFT  JOIN TSIREG REG ON PAR.CODREG = REG.CODREG
 LEFT  JOIN TGFVEN VEN ON (VEN.CODVEND = CAB.CODVEND)
 LEFT  JOIN TGFVAR VAR ON (VAR.NUNOTA = ITE.NUNOTA AND VAR.SEQUENCIA = ITE.SEQUENCIA)
 LEFT  JOIN TGFNAT NAT ON NAT.CODNAT = CAB.CODNAT
 LEFT  JOIN TCBPLA PLA ON PLA.CODCTACTB = NAT.CODCTACTB
 LEFT  JOIN TSICUS CUS ON CUS.CODCENCUS = CAB.CODCENCUS
 INNER JOIN TGFTOP TOP ON CAB.CODTIPOPER = TOP.CODTIPOPER AND CAB.DHTIPOPER = TOP.DHALTER
 INNER JOIN TGFPRO PROD ON ITE.CODPROD = PROD.CODPROD
 LEFT  JOIN TGFGRU GRU ON PROD.CODGRUPOPROD = GRU.CODGRUPOPROD
 LEFT  JOIN TGFICM ICM ON ICM.IDALIQ = ITE.IDALIQICMS
 LEFT  JOIN TGFVOA VOA ON PROD.CODPROD = VOA.CODPROD AND VOA.CODVOL = ITE.Codvol
 LEFT  JOIN (SELECT SUM(BASERED) BASEICMS, SUM(VALOR) VLRICMS,
            SUM(VLRDIFALDEST) VLRDIFALDEST, SUM(VLRFCP) VLRFCP,
            SUM(BASEDIFAL) BASEDIFAL, SUM(BASEFCP) BASEFCP,
            CODIMP, SEQUENCIA, NUNOTA
            FROM TGFDIN
            GROUP BY CODIMP, SEQUENCIA, NUNOTA) DIN ON CAB.NUNOTA = DIN.NUNOTA AND DIN.SEQUENCIA = ITE.SEQUENCIA AND DIN.CODIMP = 1
 LEFT JOIN OutrosImpostosPV IMP on ite.nunota = IMP.nunota and ite.sequencia = imp.sequencia
 LEFT JOIN TSICID CID ON  PAR.CODCID = CID.CODCID
 LEFT JOIN TSIUFS UFS ON  CID.UF = UFS.CODUF
 LEFT JOIN TGFTPP TPP ON PAR.CODTIPPARC = TPP.CODTIPPARC
 LEFT JOIN TGFVEN GER ON (VEN.Codger = GER.CODVEND)
 LEFT JOIN AD_AGRUPPROD AGRUP ON PROD.AD_CODAGRUPPROD = AGRUP.CODAGRUPPROD
 LEFT JOIN TSIEMP EMP ON EMP.CODEMP = CAB.CODEMP
 LEFT JOIN TSICID CIDEMP ON  CIDEMP.CODCID = EMP.CODCID
 LEFT JOIN TSIUFS UFSEMP ON  CIDEMP.UF = UFSEMP.CODUF
 LEFT JOIN TGFCAB CAB_PED ON CAB_PED.NUNOTA = VAR.NUNOTAORIG
 LEFT JOIN TGFTPV TPV ON CAB.CODTIPVENDA = TPV.CODTIPVENDA

 WHERE CAB.STATUSNOTA = 'L'
   AND (CAB.statusnfe = 'A' or CAB.statusnfse = 'A')
   AND TOP.TIPMOV = 'V'
   AND TOP.GRUPO  = 'Complementar'

UNION ALL

SELECT distinct
       CAB.DTENTSAI,
       CAB.DTNEG AS DTNEG,
       CAB.DTFATUR AS DTFATUR,
       CAB.CODEMP AS EMPRESA,
       EMP.RAZAOSOCIAL,
       CIDEMP.NOMECID CID_ORIGEM,
       UFSEMP.UF  UF_ORIGEM,
       CAB.NUNOTA,
       CAB.NUMNOTA || '/' || CAB.SERIENOTA AS NOTA_FISCAL,
       VAR.NUNOTAORIG AS PEDIDO,
       CAB.AD_NUINVOICE,
       CAB.CODPARC AS PARCEIRO,
       PAR.NOMEPARC,
       PAR.CODPARCMATRIZ ,
       MAT.NOMEPARC NOMEPARCMATRIZ,
       CAB.CODNAT,
       NAT.DESCRNAT,
       nvl(NAT.CODCTACTB,top.codctactbefd) CODCTACTB,
       PLA.DESCRCTA,
       CAB.CODVEND AS COD_VENDEDOR,
       VEN.APELIDO   AS VENDEDOR,
       CAB.CODTIPOPER AS TOP,
       TOP.DESCROPER AS DESC_TOP,
       ITE.SEQUENCIA,
       ITE.CODPROD,
       PROD.DESCRPROD,
       VOA.CODBARRA AS EAN,
       ITE.ALIQICMS,
       DIN.BASEICMS,
       DIN.VLRICMS,
       ITE.ALIQIPI,
       ITE.VLRIPI,
       ITE.BASEIPI,
       ITE.BASESUBSTIT,
       ITE.VLRSUBST,
       ITE.CODCFO,
       ITE.QTDNEG * -1 QTDNEG,
       PROD.NCM,
       COALESCE(ITE.VLRUNIT,ITE.Vlrunitmoe) * -1 VLRUNIT,
       CAB.VLRNOTA * -1 VLR_NF,
      (ITE.VLRTOT  - ITE.VLRDESC ) AS VALOR_ITEM,
      case when CAB.CODNAT = '1010102' then DIN.BASEICMS else (ITE.Vlrtot + ITE.VLRIPI + ITE.VLRSUBST) - ITE.VLRDESC end  VALOR_ITEM_IMPOSTOS,
       CAB.VLRMOEDA * -1 VLRMOEDA,
       ITE.VLRISS,
       ITE.VLRDESC,
       PROD.CODGRUPOPROD,
       GRU.DESCRGRUPOPROD,
       PROD.MARCA,
      REG.NOMEREG,
       TOP.GRUPO,
       TOP.TIPMOV,
       TO_CHAR(CAB.DTENTSAI, 'mm/yyyy') MES_ANO,
       ITE.Vlrtot VLRTOTITE,
       CAB.VLRDESCTOT, CAB.VLRDESCTOTITEM, CAB.VLRDESCTOTITEMMOE,
       CUS.DESCRCENCUS,
       (IMP.ICMS * -1 ) ICMS,
       (IMP.ST  * -1 ) ST,
       (IMP.IPI * -1 ) IPI,
       (IMP.ISS * -1 ) ISS,
       (IMP.PIS * -1 )  PIS,
       (IMP.COFINS * -1 ) COFINS,
      CASE WHEN (CAB.VLRDESCTOT+ CAB.VLRDESCTOTITEM +CAB.VLRDESCTOTITEMMOE) > 1 THEN '#FF0000'
      ELSE '' END AS FGCOLOR,
      '' TipoDesconto,
      CID.NOMECID,
      UFS.DESCRICAO,
      UFS.UF,
      0 NetPrice,
        PAR.CODTIPPARC,
        TPP.DESCRTIPPARC,
        DIN.VLRDIFALDEST,
        DIN.VLRFCP,
        DIN.BASEDIFAL,
        DIN.BASEFCP,
        ITE.IDALIQICMS,
        ICM.MARGLUCRO,
        ICM.ALIQSUBTRIB,
        ICM.PERCSTFCPINT,
        PAR.CGC_CPF,
        PAR.TIPPESSOA,
        GER.APELIDO GERENTE,
        PLA.AD_CODCTACTB CTACONCIL,
        CAB.CODCENCUS,
        AGRUP.CODAGRUPPROD,
        AGRUP.DESCRAGRUPPROD,
        '' TABPRECO,
        0 Royalties_Taxa,
        case when CAB.TIPFRETE = 'N' THEN 0 ELSE CAB.VLRFRETE END VLRFRETE,
     --   (select max(sequencia) Seq from tgfite where nunota = cab.nunota) SEQITE,
        cab.tipfrete,
        CAB_PED.DTNEG DTPEDIDO,
        EMP.NOMEFANTASIA,
        CAB.DTALTER,
        cab.codtipvenda,
        TPV.DESCRTIPVENDA,
        CAB_PED.NUNOTA NUNOTA_PED,
        CAB_PED.AD_NUNOTA AD_NUNOTA,
        CAB_PED.AD_NUNOTAORIG
FROM TGFCAB CAB
 INNER JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA AND CAB.CODEMP = ITE.CODEMP
 INNER JOIN TGFPAR PAR ON (PAR.CODPARC = CAB.CODPARC)
 LEFT  JOIN TGFPAR MAT ON (MAT.CODPARC  = PAR.CODPARCMATRIZ)
 LEFT  JOIN TSIREG REG ON PAR.CODREG = REG.CODREG
 LEFT  JOIN TGFVEN VEN ON (VEN.CODVEND = CAB.CODVEND)
 LEFT  JOIN TGFVAR VAR ON (VAR.NUNOTA = ITE.NUNOTA AND VAR.SEQUENCIA = ITE.SEQUENCIA)
 LEFT  JOIN TGFNAT NAT ON NAT.CODNAT = CAB.CODNAT
 LEFT  JOIN TSICUS CUS ON CUS.CODCENCUS = CAB.CODCENCUS
 INNER JOIN TGFTOP TOP ON CAB.CODTIPOPER = TOP.CODTIPOPER AND CAB.DHTIPOPER = TOP.DHALTER
 LEFT  JOIN TCBPLA PLA ON PLA.CODCTACTB = nvl(NAT.CODCTACTB,top.codctactbefd)
 INNER JOIN TGFPRO PROD ON ITE.CODPROD = PROD.CODPROD
 LEFT  JOIN TGFGRU GRU ON PROD.CODGRUPOPROD = GRU.CODGRUPOPROD
 LEFT  JOIN TGFICM ICM ON ICM.IDALIQ = ITE.IDALIQICMS
 LEFT  JOIN TGFVOA VOA ON PROD.CODPROD = VOA.CODPROD AND VOA.CODVOL = ITE.Codvol
 LEFT  JOIN (SELECT SUM(BASERED) BASEICMS, SUM(VALOR) VLRICMS,
            SUM(VLRDIFALDEST) VLRDIFALDEST, SUM(VLRFCP) VLRFCP,
            SUM(BASEDIFAL) BASEDIFAL, SUM(BASEFCP) BASEFCP,
            CODIMP, SEQUENCIA, NUNOTA
            FROM TGFDIN
            GROUP BY CODIMP, SEQUENCIA, NUNOTA) DIN ON CAB.NUNOTA = DIN.NUNOTA AND DIN.SEQUENCIA = ITE.SEQUENCIA AND DIN.CODIMP = 1
 LEFT  JOIN OutrosImpostosPV IMP on ite.nunota = IMP.nunota and ite.sequencia = imp.sequencia
 LEFT JOIN TSICID CID ON  PAR.CODCID = CID.CODCID
 LEFT JOIN TSIUFS UFS ON  CID.UF = UFS.CODUF
 LEFT JOIN TGFTPP TPP ON PAR.CODTIPPARC = TPP.CODTIPPARC
 LEFT JOIN TGFVEN GER ON (VEN.Codger = GER.CODVEND)
 LEFT JOIN AD_AGRUPPROD AGRUP ON PROD.AD_CODAGRUPPROD = AGRUP.CODAGRUPPROD
 LEFT JOIN TSIEMP EMP ON EMP.CODEMP = CAB.CODEMP
 LEFT JOIN TSICID CIDEMP ON  CIDEMP.CODCID = EMP.CODCID
 LEFT JOIN TSIUFS UFSEMP ON  CIDEMP.UF = UFSEMP.CODUF
 LEFT JOIN TGFCAB CAB_PED ON CAB_PED.NUNOTA = VAR.NUNOTAORIG
 LEFT JOIN TGFTPV TPV ON CAB.CODTIPVENDA = TPV.CODTIPVENDA

 WHERE CAB.STATUSNOTA = 'L'
   AND TOP.TIPMOV = 'D'
   AND TOP.GRUPO = 'Devolucao venda'


UNION ALL

SELECT distinct
       CAB.DTENTSAI,
       CAB.DTNEG AS DTNEG,
       CAB.DTFATUR AS DTFATUR,
       CAB.CODEMP AS EMPRESA,
       EMP.RAZAOSOCIAL,
       CIDEMP.NOMECID CID_ORIGEM,
       UFSEMP.UF  UF_ORIGEM,
       CAB.NUNOTA,
       CAB.NUMNOTA || '/' || CAB.SERIENOTA AS NOTA_FISCAL,
       VAR.NUNOTAORIG AS PEDIDO,
       CAB.AD_NUINVOICE,
       CASE WHEN CAB.CODPARCDEST = 0 THEN CAB.CODPARC ELSE  CAB.CODPARCDEST
       END AS PARCEIRO,
       PAR.NOMEPARC,
       PAR.CODPARCMATRIZ ,
       MAT.NOMEPARC NOMEPARCMATRIZ,
       CAB.CODNAT,
       NAT.DESCRNAT,
       nvl(NAT.CODCTACTB,top.codctactbefd) CODCTACTB,
       PLA.DESCRCTA,
       CAB.CODVEND AS COD_VENDEDOR,
       VEN.APELIDO   AS VENDEDOR,
       CAB.CODTIPOPER AS TOP,
       TOP.DESCROPER AS DESC_TOP,
       ITE.SEQUENCIA,
       ITE.CODPROD,
       PROD.DESCRPROD,
       VOA.CODBARRA AS EAN,
       ITE.ALIQICMS,
       DIN.BASEICMS,
       DIN.VLRICMS,
       ITE.ALIQIPI,
       ITE.VLRIPI,
       ITE.BASEIPI,
       ITE.BASESUBSTIT,
       ITE.VLRSUBST,
       ITE.CODCFO,
       ITE.QTDNEG *-1 QTDNEG,
       PROD.NCM,
       COALESCE(ITE.VLRUNIT,ITE.Vlrunitmoe) * -1 VLRUNIT,
       CAB.VLRNOTA * -1 VLR_NF,
      (ITE.VLRTOT  - ITE.VLRDESC ) AS VALOR_ITEM,
       case when CAB.CODNAT = '1010102' then DIN.BASEICMS else (ITE.Vlrtot + ITE.VLRIPI + ITE.VLRSUBST) - ITE.VLRDESC end  VALOR_ITEM_IMPOSTOS,
       CAB.VLRMOEDA * -1 VLRMOEDA,
       ITE.VLRISS,
       ITE.VLRDESC,
       PROD.CODGRUPOPROD,
       GRU.DESCRGRUPOPROD,
       PROD.MARCA,
       REG.NOMEREG,
       TOP.GRUPO,
       TOP.TIPMOV,
       TO_CHAR(CAB.DTENTSAI, 'mm/yyyy') MES_ANO,
       ITE.Vlrtot VLRTOTITE,
       CAB.VLRDESCTOT, CAB.VLRDESCTOTITEM, CAB.VLRDESCTOTITEMMOE,
       CUS.DESCRCENCUS,
       (IMP.ICMS * -1 ) ICMS,
       (IMP.ST  * -1 ) ST,
       (IMP.IPI * -1 ) IPI,
       (IMP.ISS * -1 ) ISS,
       (IMP.PIS * -1 )  PIS,
       (IMP.COFINS * -1 ) COFINS,
      CASE WHEN (CAB.VLRDESCTOT+ CAB.VLRDESCTOTITEM +CAB.VLRDESCTOTITEMMOE) > 1 THEN '#FF0000'
      ELSE '' END AS FGCOLOR,
      '' TipoDesconto,
      CID.NOMECID,
      UFS.DESCRICAO,
      UFS.UF,
      0 NetPrice,
        PAR.CODTIPPARC,
        TPP.DESCRTIPPARC,
        DIN.VLRDIFALDEST,
        DIN.VLRFCP,
        DIN.BASEDIFAL,
        DIN.BASEFCP,
        ITE.IDALIQICMS,
        ICM.MARGLUCRO,
        ICM.ALIQSUBTRIB,
        ICM.PERCSTFCPINT,
        PAR.CGC_CPF,
        PAR.TIPPESSOA,
        GER.APELIDO GERENTE,
        PLA.AD_CODCTACTB CTACONCIL,
        CAB.CODCENCUS,
        AGRUP.CODAGRUPPROD,
        AGRUP.DESCRAGRUPPROD,
        '' TABPRECO,
        0 Royalties_Taxa,
        case when CAB.TIPFRETE = 'N' THEN 0 ELSE CAB.VLRFRETE END VLRFRETE,
     --   (select max(sequencia) Seq from tgfite where nunota = cab.nunota) SEQITE,
        cab.tipfrete,
        CAB_PED.DTNEG DTPEDIDO,
        EMP.NOMEFANTASIA,
        CAB.DTALTER,
        cab.codtipvenda,
        TPV.DESCRTIPVENDA,
        CAB_PED.NUNOTA NUNOTA_PED,
        CAB_PED.AD_NUNOTA AD_NUNOTA,
        CAB_PED.AD_NUNOTAORIG
FROM TGFCAB CAB
 INNER JOIN TGFITE ITE ON CAB.NUNOTA = ITE.NUNOTA AND CAB.CODEMP = ITE.CODEMP
 INNER JOIN TGFPAR PAR ON (PAR.CODPARC = CAB.CODPARC)
 LEFT  JOIN TGFPAR MAT ON (MAT.CODPARC  = PAR.CODPARCMATRIZ)
 LEFT  JOIN TSIREG REG ON PAR.CODREG = REG.CODREG
 LEFT  JOIN TGFVEN VEN ON (VEN.CODVEND = CAB.CODVEND)
 LEFT  JOIN TGFVAR VAR ON (VAR.NUNOTA = ITE.NUNOTA AND VAR.SEQUENCIA = ITE.SEQUENCIA)
 LEFT  JOIN TGFNAT NAT ON NAT.CODNAT = CAB.CODNAT
 LEFT  JOIN TSICUS CUS ON CUS.CODCENCUS = CAB.CODCENCUS
 INNER JOIN TGFTOP TOP ON CAB.CODTIPOPER = TOP.CODTIPOPER AND CAB.DHTIPOPER = TOP.DHALTER
 LEFT  JOIN TCBPLA PLA ON PLA.CODCTACTB = nvl(NAT.CODCTACTB,top.codctactbefd)
 INNER JOIN TGFPRO PROD ON ITE.CODPROD = PROD.CODPROD
 LEFT  JOIN TGFGRU GRU ON PROD.CODGRUPOPROD = GRU.CODGRUPOPROD
 LEFT  JOIN TGFICM ICM ON ICM.IDALIQ = ITE.IDALIQICMS
 LEFT  JOIN TGFVOA VOA ON PROD.CODPROD = VOA.CODPROD AND VOA.CODVOL = ITE.Codvol
 LEFT  JOIN (SELECT SUM(BASERED) BASEICMS, SUM(VALOR) VLRICMS,
            SUM(VLRDIFALDEST) VLRDIFALDEST, SUM(VLRFCP) VLRFCP,
            SUM(BASEDIFAL) BASEDIFAL, SUM(BASEFCP) BASEFCP,
            CODIMP, SEQUENCIA, NUNOTA
            FROM TGFDIN
            GROUP BY CODIMP, SEQUENCIA, NUNOTA) DIN ON CAB.NUNOTA = DIN.NUNOTA AND DIN.SEQUENCIA = ITE.SEQUENCIA AND DIN.CODIMP = 1
 LEFT JOIN OutrosImpostosPV IMP on ite.nunota = IMP.nunota and ite.sequencia = imp.sequencia
 LEFT JOIN TSICID CID ON  PAR.CODCID = CID.CODCID
 LEFT JOIN TSIUFS UFS ON  CID.UF = UFS.CODUF
 LEFT JOIN TGFTPP TPP ON PAR.CODTIPPARC = TPP.CODTIPPARC
 LEFT JOIN TGFVEN GER ON (VEN.Codger = GER.CODVEND)
 LEFT JOIN AD_AGRUPPROD AGRUP ON PROD.AD_CODAGRUPPROD = AGRUP.CODAGRUPPROD
 LEFT JOIN TSIEMP EMP ON EMP.CODEMP = CAB.CODEMP
 LEFT JOIN TSICID CIDEMP ON  CIDEMP.CODCID = EMP.CODCID
 LEFT JOIN TSIUFS UFSEMP ON  CIDEMP.UF = UFSEMP.CODUF
 LEFT JOIN TGFCAB CAB_PED ON CAB_PED.NUNOTA = VAR.NUNOTAORIG
 LEFT JOIN TGFTPV TPV ON CAB.CODTIPVENDA = TPV.CODTIPVENDA

 WHERE CAB.STATUSNOTA = 'L'
   AND TOP.TIPMOV = 'D'
   AND TOP.GRUPO = 'Devolucao Dest'

)
ORDER BY DTENTSAI, NOTA_FISCAL
